---
- name: Common setup for all nodes
  hosts: all
  become: true

  tasks:
    # Remove bad Docker repository if it exists
    - name: Remove Docker CE repository if exists
      file:
        path: /etc/yum.repos.d/docker-ce.repo
        state: absent
    
    # Disable Docker repository if it exists
    - name: Disable Docker CE repository
      shell: yum-config-manager --disable docker-ce-stable || true
      ignore_errors: true
      changed_when: false
    
    # Update system packages
    - name: Update yum packages
      yum:
        name: "*"
        state: latest
        update_cache: true
    
    # Install Docker (Amazon Linux 2 has Docker in default repos)
    - name: Install Docker
      yum:
        name:
          - docker
        state: present
    
    # Start Docker service
    - name: Start Docker
      systemd:
        name: docker
        state: started
        enabled: true
    
    # Create Docker daemon directory
    - name: Create Docker daemon directory
      file:
        path: /etc/docker
        state: directory
    
    # Configure Docker for Kubernetes
    - name: Copy Docker daemon.json
      copy:
        src: ../files/daemon.json
        dest: /etc/docker/daemon.json
    
    - name: Restart Docker
      systemd:
        name: docker
        state: restarted
    
    # Disable swap for Kubernetes
    - name: Disable swap
      shell: swapoff -a
      changed_when: false
    
    - name: Comment out swap in /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*swap.*)$'
        replace: '#\1'
    
    # Configure kernel parameters for Kubernetes
    - name: Write Kubernetes sysctl params file
      copy:
        dest: /etc/sysctl.d/99-kubernetes.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
        mode: "0644"
    
    - name: Apply sysctl params
      command: sysctl --system
    
    # Load br_netfilter module
    - name: Load br_netfilter module
      shell: |
        modprobe br_netfilter
        echo br_netfilter > /etc/modules-load.d/br_netfilter.conf
      args:
        executable: /bin/bash
    
    # Add Kubernetes repository
    - name: Add Kubernetes repository
      yum_repository:
        name: kubernetes
        description: Kubernetes repository
        baseurl: "https://pkgs.k8s.io/core:/stable:/v1.28/rpm/"
        gpgcheck: true
        gpgkey: "https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key"
        enabled: true
    
    # Install Kubernetes tools
    - name: Install kubeadm, kubelet, kubectl
      yum:
        name:
          - kubeadm
          - kubelet
          - kubectl
        state: present
        disable_gpg_check: true
    
    # Prevent kubelet from auto-updating
    - name: Stop kubelet service
      systemd:
        name: kubelet
        state: stopped
      ignore_errors: true

    - name: Disable kubelet service
      systemd:
        name: kubelet
        enabled: false
      ignore_errors: true
    
    # Enable and start kubelet service
    - name: Enable and start kubelet service
      systemd:
        name: kubelet
        enabled: true
        state: started
